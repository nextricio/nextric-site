<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextric Mission Control | V2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f2ee; color: #1a1a1a; }
        .serif { font-family: 'Crimson Pro', serif; }
        .card { background-color: #fff; border: 1px solid #e5e1da; border-bottom: 3px solid #dcd7ce; transition: transform 0.2s; padding: 1rem; border-radius: 0.25rem; }
        .card:hover { transform: translateY(-2px); }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.05em; }
        .status-active { background-color: #059669; color: #fff; }
        .status-idle { background-color: #9ca3af; color: #fff; }
        .feed-item { border-left: 2px solid #000; padding-left: 1rem; margin-bottom: 1.5rem; }
        .pulse-active { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="p-4 md:p-12">
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#f3f2ee]">
        <div class="card p-8 rounded max-w-sm w-full text-center border-none shadow-2xl">
            <h2 class="serif text-3xl font-bold mb-4">Secured Access</h2>
            <p class="text-sm text-gray-500 mb-6 font-medium">NEXTRIC INTELLIGENCE TERMINAL</p>
            <input type="password" id="squad-key" class="w-full p-3 border border-gray-300 rounded mb-4 text-center tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
            <button onclick="checkAuth()" class="w-full bg-black text-white p-3 rounded font-bold hover:bg-gray-800 transition-colors uppercase text-sm tracking-widest">Login</button>
            <p id="auth-error" class="text-red-500 text-xs mt-3 hidden font-bold">ACCESS DENIED.</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-content" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-1000">
        <header class="flex flex-col md:flex-row justify-between items-end border-b-[6px] border-black pb-6 mb-12">
            <div>
                <p class="text-sm font-bold tracking-[0.3em] text-gray-500 mb-2 uppercase">Company Command Center</p>
                <h1 class="serif text-7xl font-bold tracking-tighter">MISSION CONTROL <span class="text-3xl align-top">v2.3</span></h1>
            </div>
            <div class="text-right mt-4 md:mt-0">
                <p class="serif text-2xl italic font-bold" id="current-date"></p>
                <div class="flex items-center justify-end gap-2 mt-1">
                    <span id="pulse-dot" class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <p class="text-xs font-bold uppercase tracking-widest">Live Feed Active</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-10">
            <div class="md:col-span-8 space-y-12">
                <section>
                    <h2 class="serif text-4xl font-bold mb-8 border-b-2 border-black pb-2 flex justify-between items-center">
                        Activity Feed
                        <span class="text-sm font-sans uppercase tracking-widest text-gray-400">Real-time Actions</span>
                    </h2>
                    <div id="activity-feed" class="space-y-6"></div>
                </section>

                <section>
                    <h2 class="serif text-4xl font-bold mb-8 border-b-2 border-black pb-2">Task Board</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-bold uppercase tracking-widest text-xs border-b border-gray-300 pb-2">Inbox</h3>
                            <div id="inbox-tasks" class="space-y-4"></div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-bold uppercase tracking-widest text-xs border-b border-gray-300 pb-2 text-blue-600">In Progress</h3>
                            <div id="inprogress-tasks" class="space-y-4"></div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-bold uppercase tracking-widest text-xs border-b border-gray-300 pb-2 text-green-600">Done</h3>
                            <div id="done-tasks" class="space-y-4"></div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="md:col-span-4 space-y-12">
                <section>
                    <h2 class="serif text-4xl font-bold mb-8 border-b-2 border-black pb-2">Active Intelligence</h2>
                    <div id="active-intelligence" class="space-y-4"></div>
                </section>
                <section>
                    <h2 class="serif text-4xl font-bold mb-8 border-b-2 border-black pb-2">Squad Comms</h2>
                    <div id="squad-comms" class="space-y-4"></div>
                </section>
                <section>
                    <h2 class="serif text-4xl font-bold mb-8 border-b-2 border-black pb-2">The Squad</h2>
                    <div id="squad-list" class="space-y-4"></div>
                </section>
            </div>
        </div>
    </div>

    <!-- RECOVERY SYNC ENGINE -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const storedKey = localStorage.getItem('squad_auth_key');
            if (storedKey === 'ghp_WnjF') showDashboard();
            document.getElementById('squad-key').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAuth(); });
        });

        function checkAuth() {
            const k = document.getElementById('squad-key').value;
            if (k === 'ghp_WnjF') {
                localStorage.setItem('squad_auth_key', k);
                showDashboard();
            } else { document.getElementById('auth-error').classList.remove('hidden'); }
        }

        function showDashboard() {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('opacity-0');
            startLiveSync();
        }

        async function startLiveSync() {
            loadAll();
            setInterval(loadAll, 15000);
        }

        async function loadAll() {
            const pulse = document.getElementById('pulse-dot');
            pulse.classList.add('pulse-active');
            
            // Timezone UTC+1
            const now = new Date();
            const utc1 = new Date(now.getTime() + (60 * 60 * 1000));
            document.getElementById('current-date').innerText = utc1.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + " (UTC+1)";

            try {
                // 1. Feed
                const fRes = await fetch('feed.json?t=' + Date.now(), { cache: "no-store" });
                const fData = await fRes.json();
                document.getElementById('activity-feed').innerHTML = fData.slice(0, 10).map(i => `
                    <div class="feed-item">
                        <p class="text-xs font-bold text-gray-400 mb-1">${i.timestamp}</p>
                        <p class="serif text-xl leading-snug">${i.content}</p>
                    </div>
                `).join('');

                // Intelligence Card
                const intel = fData.filter(i => i.content.includes('OPTIMIZING') || i.content.includes('TECHNICAL')).slice(0, 2);
                document.getElementById('active-intelligence').innerHTML = intel.map(i => `
                    <div class="card border-l-4 border-black mb-4">
                        <p class="text-[10px] uppercase font-bold mb-1">${i.agent}</p>
                        <p class="text-sm font-medium leading-relaxed">${i.content}</p>
                    </div>
                `).join('') || '<p class="text-xs text-center text-gray-400 italic">No active optimizations.</p>';

                // 2. Working.md Parsing
                const wRes = await fetch('../memory/WORKING.md?t=' + Date.now(), { cache: "no-store" });
                const wMd = await wRes.text();
                
                const parse = (tag) => {
                    const match = wMd.match(new RegExp('### ' + tag + '([\\s\\S]*?)(?=###|##|$)', 'i'));
                    if (!match) return [];
                    return match[1].trim().split('\n').filter(l => l.trim().startsWith('-')).map(l => l.replace(/- \[[x ]\] /i, '').replace(/^- /i, '').trim());
                };

                const inj = (id, tasks, style) => {
                    document.getElementById(id).innerHTML = tasks.map(t => `<div class="card text-sm font-medium mb-4 ${style}">${t}</div>`).join('') || '<p class="text-xs text-gray-400">Empty</p>';
                };

                inj('inbox-tasks', parse('Inbox'), '');
                inj('inprogress-tasks', parse('In Progress'), 'border-l-4 border-blue-600 font-bold');
                inj('done-tasks', parse('Done'), 'text-gray-400 line-through');

                // Roster
                const rMatch = wMd.match(/## Roster([\s\S]*?)(?=##|$)/);
                if (rMatch) {
                    document.getElementById('squad-list').innerHTML = rMatch[1].trim().split('\n').map(l => {
                        const name = l.match(/\*\*([^*]+)\*\*/)?.[1];
                        if (!name) return '';
                        const act = l.includes('[ACTIVE]');
                        const emo = {Echo:'üåä', Friday:'üõ†Ô∏è', Wanda:'üîÆ', Fury:'ü¶Ö', Vision:'üëÅÔ∏è'}[name] || 'üë§';
                        return `
                            <div class="card mb-4"><div class="flex justify-between items-start mb-3"><span class="text-3xl">${emo}</span>
                            <span class="status-badge ${act ? 'status-active' : 'status-idle'}">${act ? 'Active' : 'Idle'}</span></div>
                            <h4 class="text-xl font-bold">${name}</h4></div>
                        `;
                    }).join('');
                }

                // 3. Comms - Force UTC+1
                const cRes = await fetch('comms.json?t=' + Date.now(), { cache: "no-store" });
                const cData = await cRes.json();
                document.getElementById('squad-comms').innerHTML = cData.slice(-5).reverse().map(i => {
                    const t = new Date(new Date(i.timestamp).getTime() + (60 * 60 * 1000)).toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' }) + " UTC+1";
                    return `<div class="card mb-3"><p class="text-[10px] font-bold uppercase text-gray-400">${i.from} ‚Üí ${i.to} | ${t}</p><p class="text-sm italic">"${i.message}"</p></div>`;
                }).join('') || '<p class="text-xs text-center text-gray-400">Silence.</p>';

            } catch (e) { console.error(e); }
            setTimeout(() => pulse.classList.remove('pulse-active'), 1000);
        }
    </script>
</body>
</html>
